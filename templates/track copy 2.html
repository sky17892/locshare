<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>내 위치 조회하기</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}" />
  </head>
  <body class="page">
    <header class="banner banner--accent">
      <h1>실시간 위치 조회 중</h1>
      <p>이 페이지를 닫으면 조회중지됩니다.</p>
    </header>

    <main class="card">
      <section class="status">
        <p><strong>토큰:</strong> <code>{{ token }}</code></p>
        <p id="status-text" class="status__text">대기 중...</p>
        <dl class="location-grid" id="location-grid" hidden>
          <div>
            <dt>위도</dt>
            <dd id="lat-value">-</dd>
          </div>
          <div>
            <dt>경도</dt>
            <dd id="lng-value">-</dd>
          </div>
          <div>
            <dt>정확도</dt>
            <dd id="accuracy-value">-</dd>
          </div>
          <div>
            <dt>업데이트</dt>
            <dd id="timestamp-value">-</dd>
          </div>
        </dl>
        <button id="stop-btn" class="btn">조회 중지</button>
      </section>
    </main>

    <script>
      const token = '{{ token }}';
      const statusText = document.getElementById('status-text');
      const grid = document.getElementById('location-grid');

      const latEl = document.getElementById('lat-value');
      const lngEl = document.getElementById('lng-value');
      const accEl = document.getElementById('accuracy-value');
      const tsEl = document.getElementById('timestamp-value');
      const stopBtn = document.getElementById('stop-btn');

      if (!('geolocation' in navigator)) {
        statusText.textContent = '이 기기에서 위치 정보를 사용할 수 없습니다.';
      } else {
        const watchId = navigator.geolocation.watchPosition(
          async (pos) => {
            const { latitude, longitude, accuracy, heading, speed } = pos.coords;
            statusText.textContent = '위치 전송 중...';
            grid.hidden = false;
            latEl.textContent = latitude.toFixed(6);
            lngEl.textContent = longitude.toFixed(6);
            accEl.textContent = accuracy ? `${accuracy.toFixed(0)} m` : '알 수 없음';
            tsEl.textContent = new Date(pos.timestamp).toLocaleString();

            await fetch(`/api/location/${token}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                lat: latitude,
                lng: longitude,
                accuracy,
                heading,
                speed,
              }),
            });
          },
          (err) => {
            statusText.textContent = `위치 권한 필요: ${err.message}`;
          },
          {
            enableHighAccuracy: true,
            maximumAge: 5000,
            timeout: 15000,
          }
        );

        stopBtn.addEventListener('click', () => {
          navigator.geolocation.clearWatch(watchId);
          statusText.textContent = '조회를 중지했습니다.';
          grid.hidden = true;
          latEl.textContent = '-';
          lngEl.textContent = '-';
          accEl.textContent = '-';
          tsEl.textContent = '-';
          stopBtn.disabled = true;
        });
      }
    </script>
  </body>
</html>

